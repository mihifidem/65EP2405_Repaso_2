{% extends 'core/base.html' %}
{% load form_filters %}

{% load static %}

{% block title %}{{ view.object.pk|yesno:"Editar Post,Nuevo Post" }}{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="card shadow-lg border-0 mx-auto" style="max-width: 850px;">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
      <h3 class="mb-0">
        {{ view.object.pk|yesno:"‚úèÔ∏è Editar Post,üìù Crear nuevo Post" }}
      </h3>
      <a href="{% url 'core:post_list' %}" class="btn btn-outline-light btn-sm">‚Üê Volver</a>
    </div>

    <div class="card-body p-4">
      <form method="post" enctype="multipart/form-data" id="postForm">
        {% csrf_token %}

        <!-- T√≠tulo -->
        <div class="mb-3">
          <label class="form-label fw-bold">T√≠tulo</label>
          {{ form.titulo }}
        </div>

        <!-- Categor√≠a -->
        <div class="mb-3">
          <label class="form-label fw-bold">Categor√≠a</label>
          {{ form.categoria }}
        </div>

        <!-- Subcategor√≠as -->
        <div class="mb-3">
          <label class="form-label fw-bold">Subcategor√≠as</label>
          {{ form.subcategorias }}
        </div>

        <!-- Hashtags -->
        <div class="mb-3">
          <label class="form-label fw-bold">Hashtags</label>
          {{ form.hashtags }}
        </div>

        <!-- Imagen -->
        <div class="mb-3">
          <label class="form-label fw-bold">Imagen del Post</label>
          {{ form.imagen }}

          {% if form.instance.imagen %}
            <div class="mt-3 text-center">
              <p class="text-muted small mb-1">üì∏ Imagen actual:</p>
              <img
                id="previewImagen"
                src="{{ form.instance.imagen.url }}"
                alt="Imagen actual"
                class="img-fluid rounded shadow-sm"
                style="max-height:250px;"
              >
            </div>
          {% else %}
            <div class="mt-3 text-center">
              <img
                id="previewImagen"
                src="{% static 'core/img/placeholder.jpg' %}"
                alt="Vista previa"
                class="img-fluid rounded shadow-sm"
                style="max-height:250px; display:none;"
              >
            </div>
          {% endif %}
        </div>

        <!-- Contenido p√∫blico -->
        <div class="mb-3">
          <label class="form-label fw-bold">Contenido p√∫blico</label>
          <div id="editorPublico" class="form-control" style="height: 220px;"></div>
          <textarea name="contenido" id="contenido" hidden>{{ form.instance.contenido|safe }}</textarea>
        </div>

        <!-- Contenido premium -->
        <div class="mb-3">
          <label class="form-label fw-bold">Contenido Premium</label>
          <div id="editorPremium" class="form-control" style="height: 220px;"></div>
          <textarea name="contenido_premium" id="contenido_premium" hidden>{{ form.instance.contenido_premium|safe }}</textarea>
        </div>

        <div class="text-end mt-4">
          <button type="submit" id="guardarBtn" class="btn btn-success px-4">
            üíæ Guardar Post
          </button>
          <a href="{% url 'core:post_list' %}" class="btn btn-secondary px-4 ms-2">Cancelar</a>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Quill -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  console.log("üß© Editor de texto activo.");

  // Inicializar editores Quill
  const editorPublico = new Quill("#editorPublico", {
    theme: "snow",
    placeholder: "Escribe el contenido p√∫blico aqu√≠...",
  });

  const editorPremium = new Quill("#editorPremium", {
    theme: "snow",
    placeholder: "Escribe el contenido premium aqu√≠...",
  });

  // Precargar contenido existente en modo edici√≥n
  const contenido = document.getElementById("contenido").value;
  const contenidoPremium = document.getElementById("contenido_premium").value;

  if (contenido && contenido.trim() !== "") {
    editorPublico.root.innerHTML = contenido;
  }
  if (contenidoPremium && contenidoPremium.trim() !== "") {
    editorPremium.root.innerHTML = contenidoPremium;
  }

  // Copiar contenido Quill al enviar formulario
  document.getElementById("postForm").addEventListener("submit", () => {
    document.getElementById("contenido").value = editorPublico.root.innerHTML;
    document.getElementById("contenido_premium").value = editorPremium.root.innerHTML;
  });

  // üîç Vista previa de imagen seleccionada
  const inputImagen = document.getElementById("id_imagen");
  const preview = document.getElementById("previewImagen");

  if (inputImagen) {
    inputImagen.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          preview.src = ev.target.result;
          preview.style.display = "block";
        };
        reader.readAsDataURL(file);
      } else {
        preview.src = "";
        preview.style.display = "none";
      }
    });
  }
});
</script>
{% endblock %}
