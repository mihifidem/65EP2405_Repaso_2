{% extends 'core/base.html' %}
{% load form_filters %}

{% block title %}{{ view.object.pk|yesno:"Editar Post,Nuevo Post" }}{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="card shadow-lg border-0 mx-auto" style="max-width: 850px;">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
      <h3 class="mb-0">
        {{ view.object.pk|yesno:"‚úèÔ∏è Editar Post,üìù Crear nuevo Post" }}
      </h3>
      <a href="{% url 'core:post_list' %}" class="btn btn-outline-light btn-sm">‚Üê Volver</a>
    </div>

    <div class="card-body p-4">
      <form method="post" enctype="multipart/form-data" id="postForm" action="">
        {% csrf_token %}

        <!-- T√≠tulo -->
        <div class="mb-3">
          <label class="form-label fw-bold">T√≠tulo</label>
          {{ form.titulo|add_class:"form-control" }}
        </div>

        <!-- Categor√≠a -->
        <div class="mb-3">
          <label class="form-label fw-bold">Categor√≠a</label>
          {{ form.categoria|add_class:"form-select" }}
        </div>

        <!-- Subcategor√≠as -->
        <div class="mb-3">
          <label class="form-label fw-bold">Subcategor√≠as</label>
          {{ form.subcategorias|add_class:"form-select" }}
        </div>

        <!-- Hashtags -->
        <div class="mb-3">
          <label class="form-label fw-bold">Hashtags</label>
          {{ form.hashtags|add_class:"form-select" }}
        </div>

        <!-- Contenido p√∫blico -->
        <div class="mb-3">
          <label class="form-label fw-bold">Contenido p√∫blico</label>
          <div id="editorPublico" class="form-control" style="height: 220px;"></div>
          <!-- üî• usamos instance, no initial -->
          <textarea name="contenido" id="contenido" hidden>{{ form.instance.contenido|safe }}</textarea>
        </div>

        <!-- Contenido premium -->
        <div class="mb-3">
          <label class="form-label fw-bold">Contenido Premium</label>
          <div id="editorPremium" class="form-control" style="height: 220px;"></div>
          <textarea name="contenido_premium" id="contenido_premium" hidden>{{ form.instance.contenido_premium|safe }}</textarea>
        </div>

        <div class="text-end mt-4">
          <button type="submit" id="guardarBtn" class="btn btn-success px-4">
            üíæ Guardar Post
          </button>
          <a href="{% url 'core:post_list' %}" class="btn btn-secondary px-4 ms-2">Cancelar</a>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  console.log("üß© Editor de texto activo.");

  const editorPublico = new Quill("#editorPublico", {
    theme: "snow",
    placeholder: "Escribe el contenido p√∫blico aqu√≠...",
  });

  const editorPremium = new Quill("#editorPremium", {
    theme: "snow",
    placeholder: "Escribe el contenido premium aqu√≠...",
  });

  // üîπ Precargar contenido existente en modo edici√≥n
  const contenido = document.getElementById("contenido").value;
  const contenidoPremium = document.getElementById("contenido_premium").value;

  if (contenido && contenido.trim() !== "") {
    editorPublico.root.innerHTML = contenido;
  }
  if (contenidoPremium && contenidoPremium.trim() !== "") {
    editorPremium.root.innerHTML = contenidoPremium;
  }

  // üîπ Copiar valores al enviar formulario
  document.getElementById("postForm").addEventListener("submit", () => {
    document.getElementById("contenido").value = editorPublico.root.innerHTML;
    document.getElementById("contenido_premium").value = editorPremium.root.innerHTML;
  });
});
</script>
{% endblock %}
