{% extends 'core/base.html' %}
{% load static %}
{% block content %}

<div class="container py-4">
  <div class="card shadow-sm border-0 rounded-4">
    <div class="card-body p-4">

      <h2 class="mb-4 text-center">
        {% if object %}
          âœï¸ Editar Post
        {% else %}
          ğŸ“ Crear nuevo Post
        {% endif %}
      </h2>

      <form method="post" enctype="multipart/form-data" id="postForm">
        {% csrf_token %}

        <!-- ===============================
             Campos del formulario
             =============================== -->
        <div class="mb-3">
          <label class="form-label fw-bold">TÃ­tulo</label>
          {{ form.titulo }}
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label fw-bold">CategorÃ­a</label>
            {{ form.categoria }}
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label fw-bold">SubcategorÃ­as</label>
            {{ form.subcategorias }}
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">Imagen principal</label>
          {{ form.imagen }}
        </div>

<div class="mb-3">
  <label class="form-label fw-bold">Contenido pÃºblico</label>
  {{ form.contenido }}
</div>

<div class="mb-3">
  <label class="form-label fw-bold">Contenido premium</label>
  {{ form.contenido_premium }}
</div>

        <!-- ===============================
             Hashtags dinÃ¡micos
             =============================== -->
        <div class="mb-4">
          <label for="hashtagInput" class="form-label fw-bold">AÃ±adir hashtags</label>

          <div class="input-group mb-2" style="max-width: 400px;">
            <input
              type="text"
              id="hashtagInput"
              class="form-control"
              placeholder="Escribe un hashtag y presiona Enter"
              style="border-radius: 0.5rem;"
            >
            <button id="addHashtagBtn" class="btn btn-primary" type="button">
              â• AÃ±adir
            </button>
          </div>

          <small class="text-muted d-block mb-2">
            ğŸŸ¢ Verde = existente | ğŸŸ  Naranja = nuevo hashtag creado
          </small>

          <div id="hashtagsContainer"
               class="d-flex flex-wrap gap-2 p-2 border rounded bg-light"
               style="min-height: 60px;">
            <span class="text-muted small">No hay hashtags aÃ±adidos aÃºn.</span>
          </div>
        </div>

        <!-- ===============================
             Botones
             =============================== -->
        <div class="text-center mt-4">
          <button type="submit" class="btn btn-success px-4">
            ğŸ’¾ Guardar
          </button>
          <a href="{% url 'core:post_list' %}" class="btn btn-secondary px-4">
            â¬…ï¸ Volver
          </a>
        </div>
        {{ form.media }}

      </form>

    </div>
  </div>
</div>

<!-- ===============================
     JavaScript â€” gestiÃ³n hashtags
     =============================== -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const input = document.getElementById("hashtagInput");
  const addBtn = document.getElementById("addHashtagBtn");
  const container = document.getElementById("hashtagsContainer");
  const postId = "{{ object.id|default:'' }}";

  const addHashtag = () => {
    const nombre = input.value.trim();
    if (!nombre) return;

    fetch("{% url 'core:check_or_create_hashtag' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: new URLSearchParams({ nombre, post_id: postId })
    })
    .then(res => res.json())
    .then(data => {
      if (data.error) return alert(data.error);

      const emptyText = container.querySelector(".text-muted");
      if (emptyText) emptyText.remove();

      const tag = document.createElement("span");
      tag.classList.add("badge");
      tag.style.fontSize = "1rem";
      tag.style.padding = "0.6em 0.8em";
      tag.style.borderRadius = "2rem";
      tag.style.backgroundColor = data.color === "green" ? "#b2f2bb" : "#ffd8a8";
      tag.textContent = "#" + data.nombre + " ";

      // âŒ eliminar de BD
      const delDB = document.createElement("button");
      delDB.textContent = "âŒ";
      delDB.classList.add("btn", "btn-sm", "btn-link", "p-0", "ms-1");
      delDB.style.textDecoration = "none";
      delDB.onclick = (e) => {
        e.preventDefault();
        fetch(`/ajax/delete_hashtag/${data.id}/`, {
          method: "DELETE",
          headers: {
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
          }
        }).then(() => tag.remove());
      };

      // â– eliminar solo del post
      const delPost = document.createElement("button");
      delPost.textContent = "â–";
      delPost.classList.add("btn", "btn-sm", "btn-link", "p-0", "ms-1");
      delPost.style.textDecoration = "none";
      delPost.onclick = (e) => {
        e.preventDefault();
        fetch(`/ajax/remove_hashtag/${postId}/${data.id}/`, {
          method: "DELETE",
          headers: {
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
          }
        }).then(() => tag.remove());
      };

      tag.appendChild(delDB);
      tag.appendChild(delPost);
      container.appendChild(tag);
      input.value = "";
    });
  };

  addBtn.addEventListener("click", addHashtag);
  input.addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      addHashtag();
    }
  });
});
</script>

<!-- ===============================
     Estilos adicionales (opcional)
     =============================== -->
<style>
#hashtagsContainer .badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  transition: transform 0.1s ease;
}
#hashtagsContainer .badge:hover {
  transform: scale(1.05);
}
#hashtagsContainer button {
  font-size: 0.9em;
  color: #333;
  cursor: pointer;
}
#hashtagsContainer button:hover {
  color: #d6336c;
}
</style>

{% endblock %}
